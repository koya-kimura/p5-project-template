# p5.js プロジェクトテンプレート

p5.js（インスタンスモード）とWebGLポストエフェクト、APC Mini MK2のMIDI操作を組み合わせたライブ・ビジュアル向けテンプレートです。サンプルシーン、テクスチャ管理、シェーダーパス、MIDIデバッグオーバーレイが揃っているので、リアクティブなビジュアルづくりにすぐ取り掛かれます。

## 主な特徴
- TypeScript + Vite構成でホットリロードが可能、p5.jsの型定義付き。
- `Scene`インターフェイスにより、オフスクリーン描画テクスチャへシーンをモジュール化して追加可能。
- `public/shader/post.vert`と`public/shader/post.frag`によるWebGLポストプロセスパイプライン。
- APC Mini MK2のグリッド／シーン選択・フェーダーモード・画面内デバッグ表示を標準実装。
- イージングやノイズ、BPM同期処理などのユーティリティを同梱。

## 事前準備
- Node.js 18以上（Vite 7が必要とします）。
- APC Mini MK2コントローラー（標準マッピングで利用したい場合に推奨）。
- Web MIDIに対応したブラウザ（Chromium系ブラウザがもっとも安定）。

## セットアップ手順
1. 依存パッケージをインストールします。
   ```bash
   npm install
   ```
2. 開発サーバーを起動します。
   ```bash
   npm run dev
   ```
   ターミナルに`http://localhost:5173`などのローカルURLが表示されます。Web MIDI対応ブラウザで開き、MIDI利用許可を求められたら許可してください。
3. 本番ビルドが必要な場合。
   ```bash
   npm run build
   npm run preview
   ```

## ディレクトリ構成
```
public/
  shader/          -> ポストプロセス用の頂点・フラグメントシェーダー
  font|icon|image/ -> アセット格納用のプレースホルダー
src/
  main.ts          -> p5エントリーポイント（インスタンスモードのセットアップとループ）
  core/
    texManager.ts  -> レンダーテクスチャとアクティブシーンを管理
    effectManager.ts-> ポストシェーダーの読み込み・適用
  midi/
    midiManager.ts -> Web MIDI初期化ヘルパー
    apcmini_mk2/   -> APC Mini MK2向けパターンとデバッグ描画
  scenes/          -> `Scene`インターフェイスとサンプル実装
  shaders/         -> Vite で直接読み込む GLSL 資産
  types/           -> 共通の型定義
  utils/
    animation/     -> 画像アニメーション関連ユーティリティ
    color/         -> カラーパレット定義
    debug/         -> ログ収集などデバッグ補助
    math/          -> イージングやノイズ、マッピング関数
    rhythm/        -> BPM やテンポ同期ヘルパー
    text/          -> 文字描画・判定ユーティリティ
```

## シーンと描画フロー
- `Scene`インターフェイス（`src/scenes/Scene.ts`）は`update(p)`と`draw(p, graphics)`を定義し、各シーンがロジック更新と共有`p5.Graphics`への描画を切り分けられます。
- `TexManager`はアクティブシーンの更新・描画を管理し、MIDI更新を受け取ってデバッグオーバーレイをレンダーテクスチャへ合成します。
- `EffectManager`はポストシェーダーをアクティブ化し、`u_tex``u_resolution``u_time`のUniformを渡して画面へフルスクリーン描画します。
- 新しいシーンを追加する手順：
  1. `Scene`を実装したクラスを`src/scenes/`に作成。
  2. `TexManager`の`scenes`配列にインスタンスを追加し、必要なら切り替えロジックを用意。
  3. APC Mini MK2のコールバックや独自処理で`activeSceneIndex`を切り替える。

## APC Mini MK2のワークフロー
- グリッドパッドはシーンごとのラジオセレクターとして動作し、各列に最大8段のパラメーター選択肢を割り当てます。最下段はその列をランダムモードに切り替えます。
- サイドボタン（シーンボタン）はアクティブシーンを切り替え、LEDで選択状態をフィードバックします。
- フェーダーボタンはデフォルトで「ランダム」ラッチとして動作し、対応するフェーダーを自動変調します。`setFaderButtonMode("mute")`を呼べばミュートスイッチとして機能します。
- SHIFTボタン長押しでシーンランダムモードをトグルし、ハンズフリーで巡回できます。
- `APCMiniMK2SceneMatrix.drawDebug`はコントローラーの状態をキャンバスへ投影し、ハードウェアが手元になくてもMIDI状態を確認できます。

## シェーダーの調整
- ポストエフェクト用シェーダーは`public/shader/`に配置されています。Uniformやフラグメントロジックを変更してブルームやカラーシフト、グリッチなどを実装できます。
- `EffectManager.apply`内で`shader.setUniform`を追加すれば、任意のUniformを渡せます。
- シェーダーファイルのホットリロードは自動では行われません。`npm run dev`を再起動するか、ブラウザをリロードしてください。

## テンプレート拡張のヒント
- `src/scenes/`にシーンを追加する、`src/midi/apcmini_mk2/`で`APCMiniMK2Base`を継承したパターンを作るなど、用途に応じてモジュールを増やせます。
- `BPMManager`と`src/utils/math/easing.ts`のイージングを組み合わせ、テンポに合わせたアニメーションを構築できます。
- `public/`フォルダー内のサンプルアセットを差し替え、自分のフォントやテクスチャで演出を強化してください。

## 開発ガイドライン
- プロジェクト全体の命名方針は `docs/naming-conventions.md` にまとめています。新しいファイルや型を追加する際は事前に確認してください。

## トラブルシューティング
- **MIDIデバイスが認識されない**: Web MIDIはHTTPSまたは`localhost`でのみ動作します。ChromeなどでMIDI許可ダイアログを確認し、APC Mini MK2を接続した状態でページを開いてください。
- **シェーダーのコンパイルエラー**: ブラウザのデベロッパーツールにGLSLエラーログが表示されます。Viteがシェーダーをキャッシュする場合があるため、編集後は再読み込みしてください。
- **画面が真っ暗**: `TexManager.init`が実行されているか確認してください。レンダーテクスチャが初期化されていないと`EffectManager.apply`が正しく描画できません。

Happy hacking! このテンプレートを足がかりに、自分だけのライブビジュアルセットを構築してください。